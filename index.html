<!DOCTYPE html>
<html>
<head>
<style>
.hand {
    width:1456px; height:140px;
    border:1px solid black;
    padding:4px;
    overflow-x:visible;
    white-space: nowrap
}
.card {
    border:1px solid black;
    margin-right:4px;
    width:100px; height:140px;
    display: inline-block;
}
.card:hover {
  transform: scale(2);
}
</style>
<script>

var cards = null;
var game = null;

function load_cards()
{
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            cards = JSON.parse(this.responseText);
        }
    };

    xmlhttp.open("GET", "cards.json", true);
    xmlhttp.send();
}

function hand_tostr(hand,player_id,action)
{
    var html = "<div class='hand'>";
    for (var deck in hand)
    {

        for (var card in hand[deck])
        {
            var i = hand[deck][card];
            var url = "assets/"+deck+"/"+encodeURI(cards[deck][i]);
            var img = "<img src=\"" +url+ "\" style='max-width: 100%;max-height: 100%;'>";
            var click = action+"(game, \""+player_id+"\", \""+deck+"\", "+i+")";
            html += "<div class='card' onclick='" +click+ "'>";
            html += img;
            html += "</div>";
        }
    }
    html += '</div>';
    return html;
}

function render(player,player_id)
{
    var html = "<div class='player'>";
    html += "<div>Player: " + player_id + ", Hand: </div>";
    html += hand_tostr(player.hand,player_id,"playdetail");
    html += "<div>Details in play: </div>";
    html += hand_tostr(player.play,player_id,"nop");
    html += '</div>';
    return html;
}

function game_stage_str()
{
    if (game.act == 0)
        return "Setup - Add Players and Select Alias Details.";
    
    var c = Object.keys(game.players).length;
    
    if (game.act==1 && game.scene==c)
        return "Extra Scene: Introduce a new character";

    if (game.act==1 && game.scene==c+1)
        return "First Break: The Murder";

    if (game.act==2 && game.scene==c)
        return "Second Break: The Twist";
    
    if (game.act==3)
        c = c*2;
        
    if (game.act==3 && game.scene==c)
        return "Last Break: The Accusation and The Guilty";

    var act = "";
    if (game.act==1)
        act = "Act I: Introductions";
    if (game.act==2)
        act = "Act II: Investigations";
    if (game.act==3)
        act = "Act III: Incriminations";
        
    if (game.act==4)
        act = "Epilogue";
        
    return act + " Scene " + (game.scene+1) + " / " + c;
}

function render_game(result)
{
    game = result;
    var html = "";
    
    html += "<div class='game'>";
    html += "<div>" + game_stage_str() + "</div>";
    for (var player in result.players)
        html += render(result.players[player],player);
    html += "</div>";
    
    document.getElementById('players').innerHTML = html;
}

function nop(gamestate,player_id,detail_type,detail_card)
{
}

function playdetail(gamestate,player_id,detail_type,detail_card)
{
    console.log("playdetail called:",player_id,detail_type,detail_card);
    
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var result = JSON.parse(this.responseText);
            document.getElementById('debug').innerHTML = this.responseText;
            
            render_game(result);
        }
    };
    
    // TODO get these from GET
    //$player_id = $data["play_detail"]["player_id"];
    //$detail_type = $data["play_detail"]["detail_type"];
    //$detail_card = $data["play_detail"]["detail_card"];
    gamestate["play_detail"] = {};
    gamestate["play_detail"].player_id=player_id;
    gamestate["play_detail"].detail_type=detail_type;
    gamestate["play_detail"].detail_card=detail_card;
    
    xmlhttp.open("POST", "api/play_detail.php", true);
    xmlhttp.send( JSON.stringify(gamestate) );
}

function add_player(gamestate)
{
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById('debug').innerHTML = this.responseText;
            var result = JSON.parse(this.responseText);
            render_game(result);
        }
    };

    xmlhttp.open("POST", "api/add_player.php", true);
    xmlhttp.send( JSON.stringify(gamestate) );
}

function next(gamestate)
{
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById('debug').innerHTML = this.responseText;
            var result = JSON.parse(this.responseText);
            render_game(result);
        }
    };

    xmlhttp.open("POST", "api/next.php", true);
    xmlhttp.send( JSON.stringify(gamestate) );
}

function new_game()
{
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            document.getElementById('debug').innerHTML = this.responseText;
            var result = JSON.parse(this.responseText);
            render_game(result);
        }
    };

    xmlhttp.open("GET", "api/new.php", true);
    xmlhttp.send();
}

function start()
{
    load_cards();
    new_game();
}

</script>
</head>

<body onload="start()">
<div>
<div id="debug"> </div><hr>
<input type="button" onclick="add_player(game)" value="Add Player"/>
<input type="button" onclick="next(game)" value="Next"/>
<div id="players"> </div><hr>


</body>
</html>